name: Package

on:
  push:
    branches: ["main"]

jobs:
  docs:
    runs-on: self-hosted

    steps:

    - name: Checkout
      uses: actions/checkout@v3

    - name: Switch branch to `docs-preview`
      run: git checkout docs-preview

    - name: Merge `main` branch into `docs-preview`
      run: |
        git merge origin/main

    - name: Build documentation
      run: |
        xcodebuild docbuild \
        -toolchain org.swift.57202212191a \
        -destination 'platform=macos' \
        -scheme Flock \
        -derivedDataPath FlockBuild \
        OTHER_SWIFT_FLAGS="-emit-extension-block-symbols"

    - name: Arrange files
      run: |
        rm -rf Documentation/Flock.doccarchive
        mkdir -p Documentation/Flock.doccarchive
        mv FlockBuild/Build/Products/Debug/Flock.doccarchive/* Documentation/Flock.doccarchive
        rm -rf FlockBuild

    - name: Create pull request
      uses: peter-evans/create-pull-request@v4
      with:
        branch: docs-preview
        base: docs
        commit-message: Update generated documentation
